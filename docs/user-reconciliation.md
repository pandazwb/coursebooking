# ç”¨æˆ·æ ¸è´¦åŠŸèƒ½

## åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·æ ¸è´¦åŠŸèƒ½ç”¨äºæ£€æŸ¥æ¯ä¸ªç”¨æˆ·çš„è´¦ç›®å¹³è¡¡ï¼ŒéªŒè¯ä»¥ä¸‹ç­‰å¼ï¼š
```
ç”¨æˆ·æ€»å……å€¼é‡‘é¢ = è´¦æˆ·å½“å‰ä½™é¢ + å·²æ¶ˆè´¹é‡‘é¢
```

## æ ¸è´¦åŸç†

### æ•°æ®æ¥æº
1. **å……å€¼è®°å½•**: ä» `getListOrderMvip.aspx` è·å–ç”¨æˆ·çš„å®Œæ•´å……å€¼å†å²
2. **å½“å‰ä½™é¢**: ä» `getListSYKSMembers.aspx` è·å–ç”¨æˆ·çš„ `Amount`  
3. **æ¶ˆè´¹è®°å½•**: ä» `getListPreAboutMemberSK.aspx` è·å–ç”¨æˆ·çš„ `ConsumptionOfClass`

### æ ¸è´¦é€»è¾‘
- **æ€»å……å€¼é‡‘é¢**: ç”¨æˆ·æ‰€æœ‰å……å€¼è®°å½•çš„é‡‘é¢ç´¯åŠ ï¼ˆä½¿ç”¨ `getListOrderMvip.aspx`ï¼‰
- **å½“å‰ä½™é¢**: ç”¨æˆ·æ‰€æœ‰ä¼šå‘˜å¡çš„ä½™é¢ç´¯åŠ 
- **æ€»æ¶ˆè´¹é‡‘é¢**: ç”¨æˆ·æ‰€æœ‰ä¸Šè¯¾è®°å½•çš„æ¶ˆè´¹é‡‘é¢ç´¯åŠ 
- **ç†è®ºä½™é¢**: æ€»å……å€¼ - æ€»æ¶ˆè´¹
- **å®é™…å·®é¢**: ç†è®ºä½™é¢ - å½“å‰ä½™é¢

## ä½¿ç”¨æ–¹æ³•

### 1. æ‰€æœ‰ç”¨æˆ·æ ¸è´¦

```bash
# å¯¹æ‰€æœ‰ç”¨æˆ·è¿›è¡Œæ ¸è´¦
npm run user-reconciliation

# æˆ–è€…ç›´æ¥è¿è¡Œè„šæœ¬
npx ts-node src/scripts/user-reconciliation.ts
```

### 2. å•ä¸ªç”¨æˆ·æ ¸è´¦

```bash
# æŒ‰ç”¨æˆ·IDæ ¸è´¦
npm run user-reconciliation user 478926

# æŒ‡å®šç”¨æˆ·åï¼ˆä¾¿äºè¯†åˆ«ï¼‰
npm run user-reconciliation user 478926 "å¼ ä¸‰"
```

### 3. å¸®åŠ©ä¿¡æ¯

```bash
npm run user-reconciliation --help
```

### 4. åœ¨ä»£ç ä¸­è°ƒç”¨

```typescript
import { userReconciliationService } from './src/services/user-reconciliation-service';

// æ‰€æœ‰ç”¨æˆ·æ ¸è´¦
const summary = await userReconciliationService.reconcileAllUsers();

// å•ä¸ªç”¨æˆ·æ ¸è´¦
const result = await userReconciliationService.reconcileUser('478926', 'å¼ ä¸‰');
```

## è¾“å‡ºç»“æœ

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹

```
ğŸ” å¼€å§‹æ‰€æœ‰ç”¨æˆ·æ ¸è´¦...
============================================================

ğŸ” å¼€å§‹æ ¸è´¦ç”¨æˆ·: å¼ ä¸‰
âœ… å¼ ä¸‰ (13812345678)
   å……å€¼: Â¥500.00 (2ç¬”) | ä½™é¢: Â¥127.00 | æ¶ˆè´¹: Â¥373.00

ğŸ” å¼€å§‹æ ¸è´¦ç”¨æˆ·: æå››
âŒ æå›› (13987654321)
   å……å€¼: Â¥1000.00 (3ç¬”) | ä½™é¢: Â¥200.00 | æ¶ˆè´¹: Â¥750.00
   å·®é¢: Â¥50.00 | å‡†ç¡®åº¦: 95.0%

ğŸ“Š ç”¨æˆ·æ ¸è´¦æ€»ç»“
============================================================
æ€»ç”¨æˆ·æ•°:     150
å¹³è´¦ç”¨æˆ·:     142 (94.7%)
ä¸å¹³è´¦ç”¨æˆ·:   8
æ€»å·®é¢:       Â¥125.50
å¹³å‡å·®é¢:     Â¥0.84

âš ï¸  é—®é¢˜ç”¨æˆ·åˆ—è¡¨:
   æå››: å·®é¢ Â¥50.00
   ç‹äº”: å·®é¢ Â¥25.50
   ...
```

### JSONæ–‡ä»¶è¾“å‡º

æ–‡ä»¶ä¿å­˜åœ¨ `src/output/user-reconciliation-YYYY-MM-DDTHH-mm-ss.json`

```json
{
  "exportTime": "2025-06-05 15:30:25",
  "summary": {
    "totalUsers": 150,
    "balancedUsers": 142,
    "unbalancedUsers": 8,
    "totalDifference": 125.50,
    "averageDifference": 0.84,
    "accuracyRate": 94.7,
    "problemUsers": [...]
  },
  "userReconciliations": [
    {
      "userInfo": {
        "ID": "478926",
        "Name": "å¼ ä¸‰",
        "Phone": "13812345678"
      },
      "vipCards": [...],
      "courseConsumptions": [...],
      "reconciliation": {
        "totalPurchase": 500.00,
        "currentBalance": 127.00,
        "totalConsumption": 373.00,
        "calculatedBalance": 127.00,
        "difference": 0.00,
        "isBalanced": true,
        "balanceAccuracy": 100.0
      }
    }
  ]
}
```

## æ•°æ®å­—æ®µè¯´æ˜

### ç”¨æˆ·æ ¸è´¦æ•°æ® (UserReconciliationData)

#### reconciliation å­—æ®µï¼š
- `totalPurchase`: æ€»å……å€¼é‡‘é¢ï¼ˆæ‰€æœ‰å……å€¼è®°å½•é‡‘é¢ç´¯åŠ ï¼‰
- `currentBalance`: å½“å‰ä½™é¢ï¼ˆæ‰€æœ‰ä¼šå‘˜å¡ä½™é¢ç´¯åŠ ï¼‰
- `totalConsumption`: æ€»æ¶ˆè´¹é‡‘é¢ï¼ˆæ‰€æœ‰ä¸Šè¯¾æ¶ˆè´¹ç´¯åŠ ï¼‰
- `calculatedBalance`: è®¡ç®—ä½™é¢ï¼ˆæ€»å……å€¼ - æ€»æ¶ˆè´¹ï¼‰
- `difference`: å·®é¢ï¼ˆè®¡ç®—ä½™é¢ - å½“å‰ä½™é¢ï¼‰
- `isBalanced`: æ˜¯å¦å¹³è´¦ï¼ˆå·®é¢ < 0.01å…ƒï¼‰
- `balanceAccuracy`: ä½™é¢å‡†ç¡®åº¦ç™¾åˆ†æ¯”
- `paymentCount`: å……å€¼æ¬¡æ•°

### æ ¸è´¦æ€»ç»“ (UserReconciliationSummary)
- `totalUsers`: å‚ä¸æ ¸è´¦çš„æ€»ç”¨æˆ·æ•°
- `balancedUsers`: è´¦ç›®å¹³è¡¡çš„ç”¨æˆ·æ•°
- `unbalancedUsers`: è´¦ç›®ä¸å¹³è¡¡çš„ç”¨æˆ·æ•°
- `totalDifference`: æ‰€æœ‰ç”¨æˆ·å·®é¢çš„ç»å¯¹å€¼ç´¯åŠ 
- `averageDifference`: å¹³å‡å·®é¢
- `accuracyRate`: å‡†ç¡®ç‡ï¼ˆå¹³è´¦ç”¨æˆ·æ¯”ä¾‹ï¼‰
- `problemUsers`: å­˜åœ¨é—®é¢˜çš„ç”¨æˆ·åˆ—è¡¨

## æ•°æ®å‡†ç¡®æ€§æå‡

### âœ… å·²è§£å†³çš„é—®é¢˜

1. **å¤šæ¬¡å……å€¼é—®é¢˜**: ç°åœ¨ä½¿ç”¨ `getListOrderMvip.aspx` æ¥å£è·å–å®Œæ•´å……å€¼å†å²
2. **å……å€¼è®°å½•å®Œæ•´æ€§**: å¯ä»¥è·å–æ¯ç¬”å……å€¼çš„è¯¦ç»†ä¿¡æ¯ï¼ˆé‡‘é¢ã€æ—¶é—´ã€è®¢å•å·ç­‰ï¼‰

### âš ï¸ ä»éœ€å…³æ³¨çš„é—®é¢˜

1. **é€€è´¹å’Œè°ƒè´¦**: ç³»ç»Ÿå¯èƒ½å­˜åœ¨é€€è´¹ã€æ‰‹åŠ¨è°ƒè´¦ç­‰æ“ä½œ
2. **æ•°æ®ä¸€è‡´æ€§**: ä¸åŒæ¥å£è¿”å›çš„æ•°æ®å¯èƒ½å­˜åœ¨æ—¶é—´å·®æˆ–åŒæ­¥é—®é¢˜

## è¿›ä¸€æ­¥æ”¹è¿›å»ºè®®

ä¸ºäº†è¾¾åˆ°æ›´é«˜çš„æ ¸è´¦å‡†ç¡®æ€§ï¼Œå»ºè®®å…³æ³¨ä»¥ä¸‹æ¥å£ï¼š

### 1. ç”¨æˆ·é€€è´¹è®°å½•æ¥å£
```
ç›®æ ‡: è·å–ç”¨æˆ·çš„é€€è´¹è®°å½•
æœŸæœ›æ ¼å¼:
{
  "é€€è´¹æ—¶é—´": "2025-02-01", 
  "é€€è´¹é‡‘é¢": 100.00,
  "é€€è´¹åŸå› ": "...",
  "åŸè®¢å•å·": "..."
}
```

### 2. ç”¨æˆ·è´¦æˆ·å˜åŠ¨è®°å½•æ¥å£
```
ç›®æ ‡: è·å–æ‰€æœ‰è´¦æˆ·ä½™é¢å˜åŠ¨è®°å½•ï¼ˆå……å€¼ã€æ¶ˆè´¹ã€é€€è´¹ã€è°ƒè´¦ç­‰ï¼‰
æœŸæœ›æ ¼å¼:
{
  "å˜åŠ¨æ—¶é—´": "2025-01-15",
  "å˜åŠ¨ç±»å‹": "å……å€¼|æ¶ˆè´¹|é€€è´¹|è°ƒè´¦",
  "å˜åŠ¨é‡‘é¢": 500.00,
  "å˜åŠ¨å‰ä½™é¢": 100.00,
  "å˜åŠ¨åä½™é¢": 600.00,
  "å¤‡æ³¨": "..."
}
```

## å»ºè®®çš„æ”¹è¿›æ–¹æ¡ˆ

1. **ä¸ç³»ç»Ÿç®¡ç†å‘˜ç¡®è®¤**ï¼š
   - ç°æœ‰ `PurchaseAmount` æ˜¯å¦ä¸ºç´¯è®¡å……å€¼é‡‘é¢
   - æ˜¯å¦å­˜åœ¨å…¶ä»–å……å€¼è®°å½•æŸ¥è¯¢æ¥å£

2. **æ•°æ®éªŒè¯**ï¼š
   - å¯¹æ¯”æ€»è´¦æ ¸è´¦ç»“æœï¼ŒéªŒè¯å•ç”¨æˆ·æ ¸è´¦çš„å‡†ç¡®æ€§
   - åˆ†æå·®é¢è¾ƒå¤§çš„ç”¨æˆ·ï¼Œæ‰¾å‡ºæ•°æ®å·®å¼‚åŸå› 

3. **åˆ†é˜¶æ®µå®æ–½**ï¼š
   - å…ˆåŸºäºç°æœ‰æ•°æ®å®ç°åŸºç¡€æ ¸è´¦åŠŸèƒ½
   - å‘ç°é—®é¢˜åï¼Œå†å¯»æ‰¾è¡¥å……æ•°æ®æº

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®å®‰å…¨**: âš ï¸ è¾“å‡ºæ–‡ä»¶åŒ…å«æ•æ„Ÿç”¨æˆ·ä¿¡æ¯ï¼Œå·²è‡ªåŠ¨åŠ å…¥ .gitignore
2. **æ€§èƒ½è€ƒè™‘**: å¤§é‡ç”¨æˆ·æ ¸è´¦å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
3. **ç½‘ç»œç¨³å®š**: éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥è®¿é—®å¤šä¸ªAPI
4. **æ•°æ®å‡†ç¡®æ€§**: ç»“æœå‡†ç¡®æ€§ä¾èµ–äºæ¥å£æ•°æ®çš„å®Œæ•´æ€§

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **Tokenå¤±æ•ˆ**: ç³»ç»Ÿä¼šè‡ªåŠ¨å°è¯•æ›´æ–°Token
2. **ç½‘ç»œè¶…æ—¶**: å†…ç½®é‡è¯•æœºåˆ¶å’Œè¯·æ±‚é¢‘ç‡æ§åˆ¶
3. **æ•°æ®ä¸ºç©º**: æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ä¼šå‘˜å¡è®°å½•

### è°ƒè¯•å»ºè®®

1. å…ˆæµ‹è¯•å•ä¸ªç”¨æˆ·æ ¸è´¦ï¼ŒéªŒè¯é€»è¾‘æ­£ç¡®æ€§
2. å¯¹æ¯”æ€»è´¦æ ¸è´¦å’Œç”¨æˆ·æ ¸è´¦çš„ç»“æœ
3. åˆ†æå·®é¢è¾ƒå¤§çš„ç”¨æˆ·ï¼ŒæŸ¥æ‰¾æ•°æ®æºé—®é¢˜ 